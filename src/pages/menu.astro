---
import { getCollection, getEntry, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';
import Hero from '../components/Hero.astro';
import Layout from '../layouts/Layout.astro';

const page = await getEntry('pages', 'menu');
if (!page) {
  throw new Error('Menu page not found');
}

const { Content } = await render(page);
const hero = page.data.hero ?? {
  heading: 'Seasonal Menu',
  subheading: 'Explore the latest tasting journeys from our culinary team.'
};

const menuItems = await getCollection('menu');

const categories = menuItems.reduce((acc: Record<string, CollectionEntry<'menu'>[]>, item: CollectionEntry<'menu'>) => {
  const category = item.data.category;
  acc[category] = acc[category] ?? [];
  acc[category].push(item);
  return acc;
}, {} as Record<string, CollectionEntry<'menu'>[]>);

const baseOrder = ['Starters', 'Mains', 'Desserts', 'Drinks'];
const additionalCategories = Object.keys(categories).filter((name) => !baseOrder.includes(name));
const orderedCategories = [...baseOrder, ...additionalCategories];
---

<Layout title={`Coast & Ember | ${page.data.title}`} description={page.data.seo?.description}>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-16 space-y-16">
    <Hero 
      eyebrow={hero.eyebrow}
      heading={hero.heading}
      subheading={hero.subheading}
      primaryCta={hero.primaryCta}
      secondaryCta={hero.secondaryCta}
      backgroundImage={hero.backgroundImage}
    />

    <section class="prose prose-neutral max-w-none">
      <Content />
    </section>

    <section class="space-y-12">
      {orderedCategories.map((category) => {
        const items = categories[category] ?? [];
        if (items.length === 0) return null;
        return (
          <div class="space-y-6" id={category.toLowerCase()}>
            <div class="flex items-baseline justify-between gap-4">
              <h2 class="text-3xl font-display">{category}</h2>
              <span class="text-sm uppercase tracking-wide text-base-content/60">{items.length} dishes</span>
            </div>
            <div class="grid gap-6 md:grid-cols-2">
              {items.map((item: CollectionEntry<'menu'>) => (
                <article class="card bg-base-100 border border-base-200">
                  {item.data.image && (
                    <figure class="h-48 overflow-hidden rounded-t-2xl">
                      <Image
                        src={item.data.image}
                        alt={item.data.title}
                        width={400}
                        height={300}
                        class="h-full w-full object-cover"
                        loading="lazy"
                      />
                    </figure>
                  )}
                  <div class="card-body space-y-3">
                    <div class="flex justify-between items-baseline gap-4">
                      <h3 class="card-title text-2xl font-display">{item.data.title}</h3>
                      <span class="badge badge-outline badge-lg font-semibold">{item.data.price}</span>
                    </div>
                    <p class="text-sm leading-relaxed text-base-content/80">{item.body}</p>
                    <div class="flex flex-wrap gap-2">
                      {item.data.tags?.map((tag: string) => (
                        <span class="badge badge-sm badge-secondary/20 text-secondary">{tag}</span>
                      ))}
                    </div>
                  </div>
                </article>
              ))}
            </div>
          </div>
        );
      })}
    </section>
  </div>
</Layout>
